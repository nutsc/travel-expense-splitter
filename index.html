<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Expense Splitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold text-gray-800">üí∞ Travel Expense Splitter</h1>
                <div class="flex gap-2">
                    <button onclick="refreshData()" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                        üîÑ Refresh
                    </button>
                    <button onclick="exportData()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                        üì• Export
                    </button>
                    <button onclick="clearAll()" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">
                        üóëÔ∏è Clear All
                    </button>
                </div>
            </div>

            <!-- Setup Instructions -->
            <div id="setupInstructions" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800 mb-2">
                    <strong>üîí Secure Setup Instructions:</strong>
                </p>
                <ol class="text-xs text-blue-700 ml-4 list-decimal space-y-1">
                    <li>Go to Firebase Console ‚Üí Firestore Database ‚Üí Rules</li>
                    <li>Replace with the rules shown below</li>
                    <li>Change YOUR_SECRET_PASSWORD to your own password</li>
                    <li>Click Publish</li>
                </ol>
                <button onclick="document.getElementById('rulesCode').classList.toggle('hidden')" class="mt-2 text-xs text-blue-600 underline">
                    Show Firebase Rules Code
                </button>
                <pre id="rulesCode" class="hidden mt-2 bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /travel/{document} {
      // Everyone can read
      allow read: if true;
      
      // Only allow writes with correct password
      allow write: if request.resource.data.get('_adminPassword', '') == 'YOUR_SECRET_PASSWORD';
    }
  }
}</code></pre>
            </div>

            <!-- Status -->
            <div id="status" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6 hidden">
                <p class="text-sm text-blue-800"></p>
            </div>

            <!-- People Section -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">üë• Travelers</h2>
                    <button onclick="toggleAddPerson()" class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm">
                        + Add Person
                    </button>
                </div>

                <div id="addPersonForm" class="hidden flex gap-2 mb-3">
                    <input 
                        type="text" 
                        id="newPersonInput" 
                        placeholder="Enter name"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        onkeypress="if(event.key==='Enter') addPerson()"
                    />
                    <button onclick="addPerson()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Add
                    </button>
                </div>

                <div id="peopleList" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Add Expense Form -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">Add New Expense</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input 
                        type="text" 
                        id="description" 
                        placeholder="Description (e.g., Hotel, Dinner)"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                    <input 
                        type="number" 
                        id="amount" 
                        placeholder="Amount"
                        step="0.01"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paid by:</label>
                    <select id="paidBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select person</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Split among:</label>
                    <div id="splitButtons" class="flex flex-wrap gap-2"></div>
                </div>

                <button onclick="addExpense()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    + Add Expense
                </button>
            </div>

            <!-- Expenses List -->
            <div id="expensesSection" class="mb-6 hidden">
                <h3 class="font-semibold text-gray-700 mb-3">Expenses</h3>
                <div id="expensesList" class="space-y-2"></div>
                <div class="mt-3 text-right">
                    <span id="totalExpenses" class="text-lg font-semibold text-gray-800"></span>
                </div>
            </div>

            <!-- Summary -->
            <div id="summarySection" class="hidden">
                <div class="bg-indigo-50 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Current Balances</h3>
                    <div id="balancesList" class="space-y-2"></div>
                </div>

                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-3">Settlement Plan</h3>
                    <div id="settlementsList"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-8 text-gray-500">
                <div class="text-6xl mb-3">üí∞</div>
                <p>No expenses added yet. Start by adding your first expense above!</p>
            </div>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIBYMMrMd3tiuMxSujCk0-K-fyty-aph0",
            authDomain: "travel-expenses-b24d9.firebaseapp.com",
            projectId: "travel-expenses-b24d9",
            storageBucket: "travel-expenses-b24d9.firebasestorage.app",
            messagingSenderId: "393290737674",
            appId: "1:393290737674:web:217d0ba7fd8faaec60d7f3"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            showStatus('‚úÖ Connected to Firebase!', 'success');
            setTimeout(() => hideStatus(), 3000);
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showStatus('‚ùå Firebase connection error: ' + error.message, 'error');
        }

        // State
        let people = [];
        let expenses = [];
        let splitAmong = [];

        // Load data
        async function loadData() {
            try {
                const peopleDoc = await db.collection('travel').doc('people').get();
                const expensesDoc = await db.collection('travel').doc('expenses').get();
                
                if (peopleDoc.exists) {
                    const data = peopleDoc.data();
                    // Remove the _adminPassword field before using
                    delete data._adminPassword;
                    people = data.list || ['Person A', 'Person B', 'Person C', 'Person D'];
                } else {
                    people = ['Person A', 'Person B', 'Person C', 'Person D'];
                }
                
                if (expensesDoc.exists) {
                    const data = expensesDoc.data();
                    delete data._adminPassword;
                    expenses = data.list || [];
                } else {
                    expenses = [];
                }
                
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                people = ['Person A', 'Person B', 'Person C', 'Person D'];
                expenses = [];
                render();
            }
        }

        async function saveData(requirePassword = false) {
            let adminPassword = '';
            
            // Ask for password if required (for delete/clear operations)
            if (requirePassword) {
                adminPassword = prompt('üîí Enter admin password to proceed:');
                if (!adminPassword) {
                    showStatus('‚ùå Password required', 'error');
                    setTimeout(() => hideStatus(), 2000);
                    return false;
                }
            }
            
            try {
                await db.collection('travel').doc('people').set({ 
                    list: people,
                    _adminPassword: adminPassword  // Firebase rules will check this
                });
                await db.collection('travel').doc('expenses').set({ 
                    list: expenses,
                    _adminPassword: adminPassword
                });
                return true;
            } catch (error) {
                console.error('Error saving:', error);
                if (error.code === 'permission-denied') {
                    showStatus('‚ùå Incorrect password or permission denied', 'error');
                } else {
                    showStatus('‚ùå Error saving data: ' + error.message, 'error');
                }
                setTimeout(() => hideStatus(), 3000);
                return false;
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `rounded-lg p-3 mb-6 ${type === 'success' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
            status.querySelector('p').className = `text-sm ${type === 'success' ? 'text-green-800' : 'text-red-800'}`;
            status.querySelector('p').textContent = message;
            status.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
        }

        function toggleAddPerson() {
            document.getElementById('addPersonForm').classList.toggle('hidden');
        }

        async function addPerson() {
            const input = document.getElementById('newPersonInput');
            const name = input.value.trim();
            if (name && !people.includes(name)) {
                people.push(name);
                input.value = '';
                toggleAddPerson();
                await saveData(false);  // No password needed for normal operations
                render();
            }
        }

        async function removePerson(name) {
            if (people.length > 2) {
                if (confirm(`Remove ${name}? This will also remove their expenses.`)) {
                    people = people.filter(p => p !== name);
                    expenses = expenses.filter(e => e.paidBy !== name && !e.splitAmong.includes(name));
                    const success = await saveData(true);  // Requires password
                    if (success) {
                        render();
                        showStatus('‚úÖ Person removed', 'success');
                        setTimeout(() => hideStatus(), 2000);
                    } else {
                        // Revert changes if password was wrong
                        await loadData();
                    }
                }
            }
        }

        function toggleSplit(person) {
            if (splitAmong.includes(person)) {
                splitAmong = splitAmong.filter(p => p !== person);
            } else {
                splitAmong.push(person);
            }
            renderSplitButtons();
        }

        async function addExpense() {
            const desc = document.getElementById('description').value.trim();
            const amt = parseFloat(document.getElementById('amount').value);
            const payer = document.getElementById('paidBy').value;

            if (desc && amt && payer && splitAmong.length > 0) {
                expenses.push({
                    id: Date.now(),
                    description: desc,
                    amount: amt,
                    paidBy: payer,
                    splitAmong: [...splitAmong],
                    date: new Date().toISOString()
                });

                document.getElementById('description').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('paidBy').value = '';
                splitAmong = [];

                await saveData(false);  // No password needed for adding expenses
                render();
                showStatus('‚úÖ Expense added!', 'success');
                setTimeout(() => hideStatus(), 2000);
            }
        }

        async function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                const success = await saveData(true);  // Requires password
                if (success) {
                    render();
                    showStatus('‚úÖ Expense deleted', 'success');
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    // Revert if password was wrong
                    await loadData();
                }
            }
        }

        function calculateBalances() {
            const balances = {};
            people.forEach(p => balances[p] = 0);

            expenses.forEach(exp => {
                const share = exp.amount / exp.splitAmong.length;
                balances[exp.paidBy] += exp.amount;
                exp.splitAmong.forEach(p => balances[p] -= share);
            });

            return balances;
        }

        function calculateSettlements() {
            const balances = calculateBalances();
            const settlements = [];
            
            const debtors = Object.entries(balances)
                .filter(([_, b]) => b < -0.01)
                .map(([p, b]) => ({ person: p, amount: -b }))
                .sort((a, b) => b.amount - a.amount);
            
            const creditors = Object.entries(balances)
                .filter(([_, b]) => b > 0.01)
                .map(([p, b]) => ({ person: p, amount: b }))
                .sort((a, b) => b.amount - a.amount);

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                const amount = Math.min(debtor.amount, creditor.amount);

                if (amount > 0.01) {
                    settlements.push({
                        from: debtor.person,
                        to: creditor.person,
                        amount: amount
                    });
                }

                debtor.amount -= amount;
                creditor.amount -= amount;

                if (debtor.amount < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            return settlements;
        }

        function renderSplitButtons() {
            const container = document.getElementById('splitButtons');
            container.innerHTML = people.map(p => `
                <button 
                    onclick="toggleSplit('${p}')"
                    class="px-3 py-2 rounded-lg transition ${splitAmong.includes(p) ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                >
                    ${p}
                </button>
            `).join('');
        }

        function render() {
            // People list
            document.getElementById('peopleList').innerHTML = people.map(p => `
                <div class="flex items-center gap-2 bg-indigo-100 px-3 py-2 rounded-lg">
                    <span class="text-indigo-800 font-medium">${p}</span>
                    ${people.length > 2 ? `<button onclick="removePerson('${p}')" class="text-red-600 hover:text-red-800" title="Remove (requires password)">‚úï</button>` : ''}
                </div>
            `).join('');

            // Paid by dropdown
            document.getElementById('paidBy').innerHTML = '<option value="">Select person</option>' + 
                people.map(p => `<option value="${p}">${p}</option>`).join('');

            // Split buttons
            renderSplitButtons();

            // Expenses
            if (expenses.length > 0) {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('expensesSection').classList.remove('hidden');
                document.getElementById('summarySection').classList.remove('hidden');

                const total = expenses.reduce((sum, e) => sum + e.amount, 0);
                document.getElementById('totalExpenses').textContent = `Total: $${total.toFixed(2)}`;

                document.getElementById('expensesList').innerHTML = expenses.map(exp => `
                    <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${exp.description}</div>
                            <div class="text-sm text-gray-600">
                                $${exp.amount.toFixed(2)} paid by <span class="font-medium">${exp.paidBy}</span> ‚Üí split among ${exp.splitAmong.join(', ')}
                            </div>
                        </div>
                        <button onclick="deleteExpense(${exp.id})" class="text-red-600 hover:text-red-800 ml-4" title="Delete (requires password)">üóëÔ∏è</button>
                    </div>
                `).join('');

                // Balances
                const balances = calculateBalances();
                document.getElementById('balancesList').innerHTML = people.map(p => `
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-800">${p}</span>
                        <span class="font-semibold ${balances[p] > 0.01 ? 'text-green-600' : balances[p] < -0.01 ? 'text-red-600' : 'text-gray-600'}">
                            ${balances[p] > 0.01 ? '+' : ''}$${balances[p].toFixed(2)}
                        </span>
                    </div>
                `).join('');

                // Settlements
                const settlements = calculateSettlements();
                document.getElementById('settlementsList').innerHTML = settlements.length > 0 
                    ? settlements.map(s => `
                        <div class="flex items-center gap-2 text-gray-800">
                            <span class="font-medium">${s.from}</span> pays 
                            <span class="font-medium">${s.to}</span>
                            <span class="font-semibold text-green-600">$${s.amount.toFixed(2)}</span>
                        </div>
                    `).join('')
                    : '<p class="text-gray-600">All settled up! üéâ</p>';
            } else {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('expensesSection').classList.add('hidden');
                document.getElementById('summarySection').classList.add('hidden');
            }
        }

        function refreshData() {
            showStatus('üîÑ Refreshing...', 'success');
            loadData();
            setTimeout(() => hideStatus(), 2000);
        }

        function exportData() {
            const data = { people, expenses, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `travel-expenses-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function clearAll() {
            if (confirm('‚ö†Ô∏è This will DELETE ALL data for everyone! Are you absolutely sure?')) {
                people = ['Person A', 'Person B', 'Person C', 'Person D'];
                expenses = [];
                const success = await saveData(true);  // Requires password
                if (success) {
                    render();
                    showStatus('‚úÖ All data cleared!', 'success');
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    // Revert if password was wrong
                    await loadData();
                }
            }
        }

        // Load on start
        loadData();
    </script>
</body>
</html>
