<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Expense Splitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ”’</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Travel Expense Splitter</h1>
                <p class="text-gray-600">Enter password to access</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Access Password:</label>
                <input 
                    type="password" 
                    id="loginPassword" 
                    placeholder="Enter password"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    onkeypress="if(event.key==='Enter') checkLogin()"
                />
            </div>
            
            <button 
                onclick="checkLogin()"
                class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
            >
                ğŸ”“ Access Website
            </button>
            
            <div id="loginError" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-sm text-red-800">âŒ Incorrect password. Please try again.</p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" class="hidden max-w-4xl mx-auto p-4">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <h1 class="text-3xl font-bold text-gray-800">ğŸ’° Travel Expense Splitter</h1>
                <div class="flex gap-2 flex-wrap">
                    <select id="currencySelect" onchange="changeCurrency()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="USD" data-symbol="$" data-timezone="America/New_York">ğŸ‡ºğŸ‡¸ USD ($)</option>
                        <option value="EUR" data-symbol="â‚¬" data-timezone="Europe/Paris">ğŸ‡ªğŸ‡º EUR (â‚¬)</option>
                        <option value="GBP" data-symbol="Â£" data-timezone="Europe/London">ğŸ‡¬ğŸ‡§ GBP (Â£)</option>
                        <option value="JPY" data-symbol="Â¥" data-timezone="Asia/Tokyo">ğŸ‡¯ğŸ‡µ JPY (Â¥)</option>
                        <option value="CNY" data-symbol="Â¥" data-timezone="Asia/Shanghai">ğŸ‡¨ğŸ‡³ CNY (Â¥)</option>
                        <option value="AUD" data-symbol="A$" data-timezone="Australia/Sydney">ğŸ‡¦ğŸ‡º AUD (A$)</option>
                        <option value="CAD" data-symbol="C$" data-timezone="America/Toronto">ğŸ‡¨ğŸ‡¦ CAD (C$)</option>
                        <option value="SGD" data-symbol="S$" data-timezone="Asia/Singapore">ğŸ‡¸ğŸ‡¬ SGD (S$)</option>
                        <option value="MYR" data-symbol="RM" data-timezone="Asia/Kuala_Lumpur">ğŸ‡²ğŸ‡¾ MYR (RM)</option>
                        <option value="THB" data-symbol="à¸¿" data-timezone="Asia/Bangkok">ğŸ‡¹ğŸ‡­ THB (à¸¿)</option>
                        <option value="IDR" data-symbol="Rp" data-timezone="Asia/Jakarta">ğŸ‡®ğŸ‡© IDR (Rp)</option>
                        <option value="KRW" data-symbol="â‚©" data-timezone="Asia/Seoul">ğŸ‡°ğŸ‡· KRW (â‚©)</option>
                        <option value="INR" data-symbol="â‚¹" data-timezone="Asia/Kolkata">ğŸ‡®ğŸ‡³ INR (â‚¹)</option>
                    </select>
                    <button onclick="refreshData()" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                        ğŸ”„ Refresh
                    </button>
                    <button onclick="exportData()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                        ğŸ“¥ Export
                    </button>
                    <button onclick="logout()" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm">
                        ğŸšª Logout
                    </button>
                    <button onclick="clearAll()" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">
                        ğŸ—‘ï¸ Clear All
                    </button>
                </div>
            </div>

            <!-- Status -->
            <div id="status" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6 hidden">
                <p class="text-sm text-blue-800"></p>
            </div>

            <!-- People Section -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">ğŸ‘¥ Travelers</h2>
                    <button onclick="toggleAddPerson()" class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm">
                        + Add Person
                    </button>
                </div>

                <div id="addPersonForm" class="hidden flex gap-2 mb-3">
                    <input 
                        type="text" 
                        id="newPersonInput" 
                        placeholder="Enter name"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        onkeypress="if(event.key==='Enter') addPerson()"
                    />
                    <button onclick="addPerson()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Add
                    </button>
                </div>

                <div id="peopleList" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Add Expense Form -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">Add New Expense</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input 
                        type="text" 
                        id="description" 
                        placeholder="Description (e.g., Hotel, Dinner)"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                    <input 
                        type="number" 
                        id="amount" 
                        placeholder="Amount"
                        step="0.01"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paid by:</label>
                    <select id="paidBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select person</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Split among:</label>
                    <div id="splitButtons" class="flex flex-wrap gap-2"></div>
                </div>

                <button onclick="addExpense()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    + Add Expense
                </button>
            </div>

            <!-- Expenses List -->
            <div id="expensesSection" class="mb-6 hidden">
                <h3 class="font-semibold text-gray-700 mb-3">Expenses</h3>
                <div id="expensesList" class="space-y-2"></div>
                <div class="mt-3 text-right">
                    <span id="totalExpenses" class="text-lg font-semibold text-gray-800"></span>
                </div>
            </div>

            <!-- Summary -->
            <div id="summarySection" class="hidden">
                <!-- Individual Spending -->
                <div class="bg-purple-50 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3">ğŸ’³ Individual Spending</h3>
                    <div id="spendingList" class="space-y-2"></div>
                </div>

                <!-- Current Balances -->
                <div class="bg-indigo-50 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3">ğŸ’° Current Balances</h3>
                    <p class="text-xs text-gray-600 mb-2">Positive = owed to you | Negative = you owe</p>
                    <div id="balancesList" class="space-y-2"></div>
                </div>

                <!-- Settlement Plan -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-3">âœ… Settlement Plan</h3>
                    <div id="settlementsList"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-8 text-gray-500">
                <div class="text-6xl mb-3">ğŸ’°</div>
                <p>No expenses added yet. Start by adding your first expense above!</p>
            </div>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIBYMMrMd3tiuMxSujCk0-K-fyty-aph0",
            authDomain: "travel-expenses-b24d9.firebaseapp.com",
            projectId: "travel-expenses-b24d9",
            storageBucket: "travel-expenses-b24d9.firebasestorage.app",
            messagingSenderId: "393290737674",
            appId: "1:393290737674:web:217d0ba7fd8faaec60d7f3"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // State
        let people = [];
        let expenses = [];
        let splitAmong = [];
        let currentCurrency = 'USD';
        let currencySymbol = '$';
        let currentTimezone = 'America/New_York';

        // Check if user is already logged in
        if (sessionStorage.getItem('loggedIn') === 'true') {
            showMainApp();
        }

        // Login function
        async function checkLogin() {
            const password = document.getElementById('loginPassword').value;
            
            try {
                const accessDoc = await db.collection('travel').doc('access').get();
                
                if (accessDoc.exists && accessDoc.data().password === password) {
                    sessionStorage.setItem('loggedIn', 'true');
                    showMainApp();
                    loadData();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                    document.getElementById('loginPassword').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function logout() {
            sessionStorage.removeItem('loggedIn');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        function changeCurrency() {
            const select = document.getElementById('currencySelect');
            const option = select.options[select.selectedIndex];
            
            currentCurrency = select.value;
            currencySymbol = option.getAttribute('data-symbol');
            currentTimezone = option.getAttribute('data-timezone');
            
            // Save currency preference
            saveCurrencyPreference();
            render();
        }

        async function saveCurrencyPreference() {
            try {
                await db.collection('travel').doc('settings').set({
                    currency: currentCurrency,
                    currencySymbol: currencySymbol,
                    timezone: currentTimezone,
                    _adminPassword: ''
                });
            } catch (error) {
                console.error('Error saving currency:', error);
            }
        }

        async function loadCurrencyPreference() {
            try {
                const settingsDoc = await db.collection('travel').doc('settings').get();
                if (settingsDoc.exists) {
                    const data = settingsDoc.data();
                    currentCurrency = data.currency || 'USD';
                    currencySymbol = data.currencySymbol || '$';
                    currentTimezone = data.timezone || 'America/New_York';
                    
                    // Update select dropdown
                    document.getElementById('currencySelect').value = currentCurrency;
                }
            } catch (error) {
                console.error('Error loading currency:', error);
            }
        }

        function formatDateTime(isoDate) {
            try {
                const date = new Date(isoDate);
                return date.toLocaleString('en-US', {
                    timeZone: currentTimezone,
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return new Date(isoDate).toLocaleString();
            }
        }

        async function loadData() {
            try {
                await loadCurrencyPreference();
                
                const peopleDoc = await db.collection('travel').doc('people').get();
                const expensesDoc = await db.collection('travel').doc('expenses').get();
                
                if (peopleDoc.exists) {
                    const data = peopleDoc.data();
                    delete data._adminPassword;
                    people = data.list || ['Person A', 'Person B', 'Person C', 'Person D'];
                } else {
                    people = ['Person A', 'Person B', 'Person C', 'Person D'];
                }
                
                if (expensesDoc.exists) {
                    const data = expensesDoc.data();
                    delete data._adminPassword;
                    expenses = data.list || [];
                } else {
                    expenses = [];
                }
                
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                people = ['Person A', 'Person B', 'Person C', 'Person D'];
                expenses = [];
                render();
            }
        }

        async function saveData(requirePassword = false) {
            let adminPassword = '';
            
            if (requirePassword) {
                adminPassword = prompt('ğŸ”’ Enter admin password to proceed:');
                if (!adminPassword) {
                    showStatus('âŒ Password required', 'error');
                    setTimeout(() => hideStatus(), 2000);
                    return false;
                }
            }
            
            try {
                await db.collection('travel').doc('people').set({ 
                    list: people,
                    _adminPassword: adminPassword || ''
                });
                await db.collection('travel').doc('expenses').set({ 
                    list: expenses,
                    _adminPassword: adminPassword || ''
                });
                
                console.log('Data saved successfully!');
                return true;
            } catch (error) {
                console.error('Error saving:', error);
                
                if (error.code === 'permission-denied') {
                    showStatus('âŒ Permission denied. Check Firebase Rules!', 'error');
                } else {
                    showStatus('âŒ Error saving data: ' + error.message, 'error');
                }
                setTimeout(() => hideStatus(), 5000);
                return false;
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `rounded-lg p-3 mb-6 ${type === 'success' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
            status.querySelector('p').className = `text-sm ${type === 'success' ? 'text-green-800' : 'text-red-800'}`;
            status.querySelector('p').textContent = message;
            status.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
        }

        function toggleAddPerson() {
            document.getElementById('addPersonForm').classList.toggle('hidden');
        }

        async function addPerson() {
            const input = document.getElementById('newPersonInput');
            const name = input.value.trim();
            if (name && !people.includes(name)) {
                people.push(name);
                input.value = '';
                toggleAddPerson();
                await saveData(false);
                render();
            }
        }

        async function removePerson(name) {
            if (people.length > 2) {
                if (confirm(`Remove ${name}? This will also remove their expenses.`)) {
                    people = people.filter(p => p !== name);
                    expenses = expenses.filter(e => e.paidBy !== name && !e.splitAmong.includes(name));
                    const success = await saveData(true);
                    if (success) {
                        render();
                        showStatus('âœ… Person removed', 'success');
                        setTimeout(() => hideStatus(), 2000);
                    } else {
                        await loadData();
                    }
                }
            }
        }

        function toggleSplit(person) {
            if (splitAmong.includes(person)) {
                splitAmong = splitAmong.filter(p => p !== person);
            } else {
                splitAmong.push(person);
            }
            renderSplitButtons();
        }

        async function addExpense() {
            const desc = document.getElementById('description').value.trim();
            const amt = parseFloat(document.getElementById('amount').value);
            const payer = document.getElementById('paidBy').value;

            if (desc && amt && payer && splitAmong.length > 0) {
                expenses.push({
                    id: Date.now(),
                    description: desc,
                    amount: amt,
                    paidBy: payer,
                    splitAmong: [...splitAmong],
                    date: new Date().toISOString(),
                    timezone: currentTimezone,
                    currency: currentCurrency,
                    currencySymbol: currencySymbol
                });

                document.getElementById('description').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('paidBy').value = '';
                splitAmong = [];

                await saveData(false);
                render();
                showStatus('âœ… Expense added!', 'success');
                setTimeout(() => hideStatus(), 2000);
            }
        }

        async function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                const success = await saveData(true);
                if (success) {
                    render();
                    showStatus('âœ… Expense deleted', 'success');
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    await loadData();
                }
            }
        }

        function calculateBalances() {
            const balances = {};
            people.forEach(p => balances[p] = 0);

            expenses.forEach(exp => {
                const share = exp.amount / exp.splitAmong.length;
                balances[exp.paidBy] += exp.amount;
                exp.splitAmong.forEach(p => balances[p] -= share);
            });

            return balances;
        }

        function calculateIndividualSpending() {
            const spending = {};
            people.forEach(p => spending[p] = 0);

            expenses.forEach(exp => {
                const share = exp.amount / exp.splitAmong.length;
                exp.splitAmong.forEach(p => {
                    spending[p] += share;
                });
            });

            return spending;
        }

        function calculateSettlements() {
            const balances = calculateBalances();
            const settlements = [];
            
            const debtors = Object.entries(balances)
                .filter(([_, b]) => b < -0.01)
                .map(([p, b]) => ({ person: p, amount: -b }))
                .sort((a, b) => b.amount - a.amount);
            
            const creditors = Object.entries(balances)
                .filter(([_, b]) => b > 0.01)
                .map(([p, b]) => ({ person: p, amount: b }))
                .sort((a, b) => b.amount - a.amount);

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                const amount = Math.min(debtor.amount, creditor.amount);

                if (amount > 0.01) {
                    settlements.push({
                        from: debtor.person,
                        to: creditor.person,
                        amount: amount
                    });
                }

                debtor.amount -= amount;
                creditor.amount -= amount;

                if (debtor.amount < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            return settlements;
        }

        function renderSplitButtons() {
            const container = document.getElementById('splitButtons');
            container.innerHTML = people.map(p => `
                <button 
                    onclick="toggleSplit('${p}')"
                    class="px-3 py-2 rounded-lg transition ${splitAmong.includes(p) ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                >
                    ${p}
                </button>
            `).join('');
        }

        function render() {
            document.getElementById('peopleList').innerHTML = people.map(p => `
                <div class="flex items-center gap-2 bg-indigo-100 px-3 py-2 rounded-lg">
                    <span class="text-indigo-800 font-medium">${p}</span>
                    ${people.length > 2 ? `<button onclick="removePerson('${p}')" class="text-red-600 hover:text-red-800" title="Remove (requires password)">âœ•</button>` : ''}
                </div>
            `).join('');

            document.getElementById('paidBy').innerHTML = '<option value="">Select person</option>' + 
                people.map(p => `<option value="${p}">${p}</option>`).join('');

            renderSplitButtons();

            if (expenses.length > 0) {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('expensesSection').classList.remove('hidden');
                document.getElementById('summarySection').classList.remove('hidden');

                const total = expenses.reduce((sum, e) => sum + e.amount, 0);
                document.getElementById('totalExpenses').textContent = `Total: ${currencySymbol}${total.toFixed(2)} ${currentCurrency}`;

                document.getElementById('expensesList').innerHTML = expenses.map(exp => `
                    <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${exp.description}</div>
                            <div class="text-sm text-gray-600">
                                ${exp.currencySymbol || currencySymbol}${exp.amount.toFixed(2)} ${exp.currency || currentCurrency} paid by <span class="font-medium">${exp.paidBy}</span> â†’ split among ${exp.splitAmong.join(', ')}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                ğŸ“… ${formatDateTime(exp.date)}
                            </div>
                        </div>
                        <button onclick="deleteExpense(${exp.id})" class="text-red-600 hover:text-red-800 ml-4" title="Delete (requires password)">ğŸ—‘ï¸</button>
                    </div>
                `).join('');

                // Individual Spending
                const spending = calculateIndividualSpending();
                document.getElementById('spendingList').innerHTML = people.map(p => `
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-800">${p}</span>
                        <span class="font-semibold text-purple-600">
                            ${currencySymbol}${spending[p].toFixed(2)}
                        </span>
                    </div>
                `).join('');

                // Balances
                const balances = calculateBalances();
                document.getElementById('balancesList').innerHTML = people.map(p => `
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-800">${p}</span>
                        <span class="font-semibold ${balances[p] > 0.01 ? 'text-green-600' : balances[p] < -0.01 ? 'text-red-600' : 'text-gray-600'}">
                            ${balances[p] > 0.01 ? '+' : ''}${currencySymbol}${balances[p].toFixed(2)}
                        </span>
                    </div>
                `).join('');

                // Settlements
                const settlements = calculateSettlements();
                document.getElementById('settlementsList').innerHTML = settlements.length > 0 
                    ? settlements.map(s => `
                        <div class="flex items-center gap-2 text-gray-800">
                            <span class="font-medium">${s.from}</span> pays 
                            <span class="font-medium">${s.to}</span>
                            <span class="font-semibold text-green-600">${currencySymbol}${s.amount.toFixed(2)}</span>
                        </div>
                    `).join('')
                    : '<p class="text-gray-600">All settled up! ğŸ‰</p>';
            } else {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('expensesSection').classList.add('hidden');
                document.getElementById('summarySection').classList.add('hidden');
            }
        }

        function refreshData() {
            showStatus('ğŸ”„ Refreshing...', 'success');
            loadData();
            setTimeout(() => hideStatus(), 2000);
        }

        function exportData() {
            const data = { 
                people, 
                expenses, 
                currency: currentCurrency,
                currencySymbol: currencySymbol,
                exportDate: new Date().toISOString() 
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `travel-expenses-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function clearAll() {
            if (confirm('âš ï¸ This will DELETE ALL data for everyone! Are you absolutely sure?')) {
                people = ['Person A', 'Person B', 'Person C', 'Person D'];
                expenses = [];
                const success = await saveData(true);
                if (success) {
                    render();
                    showStatus('âœ… All data cleared!', 'success');
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    await loadData();
                }
            }
        }
    </script>
</body>
</html>
